<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS-Potato File Upload Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .section:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }
        
        .section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }
        
        .progress {
            width: 100%;
            height: 8px;
            background: #e1e5e9;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .log {
            background: #f7fafc;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .log-success {
            background: #f0fff4;
            color: #22543d;
            border-left: 4px solid #48bb78;
        }
        
        .log-error {
            background: #fff5f5;
            color: #742a2a;
            border-left: 4px solid #f56565;
        }
        
        .log-info {
            background: #ebf8ff;
            color: #2a4365;
            border-left: 4px solid #4299e1;
        }
        
        .file-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        .file-item:hover {
            background: #f7fafc;
            border-color: #667eea;
        }
        
        .file-info {
            flex: 1;
        }
        
        .file-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .file-meta {
            font-size: 0.9rem;
            color: #666;
        }
        
        .file-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.9rem;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-warning {
            background: #fffaf0;
            color: #744210;
            border: 1px solid #fbd38d;
        }
        
        .cors-debug {
            background: #f0f8ff;
            border: 1px solid #bee3f8;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .cors-debug h4 {
            color: #2a4365;
            margin-bottom: 10px;
        }
        
        .cors-debug ul {
            margin-left: 20px;
            color: #2d3748;
        }
        
        .cors-debug li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü•î AWS-Potato</h1>
            <p>File Upload & Download Test Interface</p>
        </div>
        
        <div class="content">
            <div class="alert alert-warning">
                <strong>‚ö†Ô∏è Setup Required:</strong> Please update the API_BASE_URL and AUTH_TOKEN variables in the JavaScript section below with your actual values.
            </div>
            
            <!-- Configuration Section -->
            <div class="section">
                <h3>‚öôÔ∏è Configuration</h3>
                <div class="form-group">
                    <label for="apiUrl">API Base URL:</label>
                    <input type="text" id="apiUrl" placeholder="https://your-api-gateway-url.amazonaws.com/prod" />
                </div>
                <div class="form-group">
                    <label for="authToken">Auth Token:</label>
                    <input type="password" id="authToken" placeholder="Your JWT token from signin" />
                </div>
                <button class="btn" onclick="saveConfig()">üíæ Save Configuration</button>
                <button class="btn btn-secondary" onclick="testConnection()">üîó Test Connection</button>
            </div>
            
            <!-- File Upload Section -->
            <div class="section">
                <h3>üì§ File Upload</h3>
                <div class="form-group">
                    <label for="fileInput">Select File:</label>
                    <input type="file" id="fileInput" />
                </div>
                <div class="form-group">
                    <label for="projectId">Project ID (Optional):</label>
                    <input type="text" id="projectId" value="test-project" />
                </div>
                <button class="btn" onclick="uploadFile()">üöÄ Upload File</button>
                <div class="progress" id="uploadProgress" style="display: none;">
                    <div class="progress-bar" id="uploadProgressBar"></div>
                </div>
            </div>
            
            <!-- File Management Section -->
            <div class="section">
                <h3>üìÅ File Management</h3>
                <button class="btn btn-secondary" onclick="listFiles()">üìã List Files</button>
                <button class="btn btn-danger" onclick="clearFileList()">üóëÔ∏è Clear List</button>
                <div id="fileList" class="file-list"></div>
            </div>
            
            <!-- Download Testing Section -->
            <div class="section">
                <h3>üì• Download Testing</h3>
                <div class="form-group">
                    <label for="downloadFileId">File ID for Download Test:</label>
                    <input type="text" id="downloadFileId" placeholder="Enter file ID to test download" />
                </div>
                <button class="btn" onclick="testDownloadUrl()">üîó Generate Download URL</button>
                <button class="btn btn-secondary" onclick="testFetchDownload()">üì• Test Fetch Download</button>
                <button class="btn btn-secondary" onclick="testDirectDownload()">‚¨áÔ∏è Test Direct Download</button>
                
                <div class="cors-debug">
                    <h4>üõ†Ô∏è CORS Download Methods:</h4>
                    <ul>
                        <li><strong>Direct Download:</strong> Opens download in new tab (bypasses CORS)</li>
                        <li><strong>Fetch Download:</strong> Uses JavaScript fetch (requires CORS)</li>
                        <li><strong>Anchor Download:</strong> Creates downloadable link (bypasses CORS)</li>
                    </ul>
                </div>
            </div>
            
            <!-- Activity Log -->
            <div class="section">
                <h3>üìä Activity Log</h3>
                <button class="btn btn-danger btn-small" onclick="clearLog()">Clear Log</button>
                <div id="activityLog" class="log"></div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        let API_BASE_URL = localStorage.getItem('apiBaseUrl') || '';
        let AUTH_TOKEN = localStorage.getItem('authToken') || '';
        
        // Load saved configuration
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('apiUrl').value = API_BASE_URL;
            document.getElementById('authToken').value = AUTH_TOKEN;
        });
        
        function saveConfig() {
            API_BASE_URL = document.getElementById('apiUrl').value;
            AUTH_TOKEN = document.getElementById('authToken').value;
            
            localStorage.setItem('apiBaseUrl', API_BASE_URL);
            localStorage.setItem('authToken', AUTH_TOKEN);
            
            log('Configuration saved successfully!', 'success');
        }
        
        function log(message, type = 'info') {
            const logElement = document.getElementById('activityLog');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `<strong>${timestamp}:</strong> ${message}`;
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('activityLog').innerHTML = '';
        }
        
        async function testConnection() {
            if (!API_BASE_URL || !AUTH_TOKEN) {
                log('Please configure API URL and Auth Token first', 'error');
                return;
            }
            
            try {
                log('Testing API connection...', 'info');
                
                const response = await fetch(`${API_BASE_URL}/file-upload`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        action: 'list'
                    })
                });
                
                if (response.ok) {
                    log('‚úÖ API connection successful!', 'success');
                } else {
                    const errorText = await response.text();
                    log(`‚ùå API connection failed: ${response.status} - ${errorText}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Connection error: ${error.message}`, 'error');
            }
        }
        
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const projectId = document.getElementById('projectId').value;
            
            if (!fileInput.files[0]) {
                log('Please select a file first', 'error');
                return;
            }
            
            if (!API_BASE_URL || !AUTH_TOKEN) {
                log('Please configure API URL and Auth Token first', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            log(`Starting upload for: ${file.name} (${file.size} bytes)`, 'info');
            
            try {
                // Step 1: Get upload URL
                log('üîÑ Requesting upload URL...', 'info');
                const uploadResponse = await fetch(`${API_BASE_URL}/file-upload`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        action: 'upload',
                        filename: file.name,
                        project_id: projectId || undefined
                    })
                });
                
                if (!uploadResponse.ok) {
                    const errorText = await uploadResponse.text();
                    throw new Error(`Upload URL request failed: ${uploadResponse.status} - ${errorText}`);
                }
                
                const uploadData = await uploadResponse.json();
                log(`‚úÖ Upload URL generated! File ID: ${uploadData.file_id}`, 'success');
                
                // Step 2: Upload to S3
                log('üîÑ Uploading to S3...', 'info');
                document.getElementById('uploadProgress').style.display = 'block';
                
                const s3Response = await fetch(uploadData.upload_url, {
                    method: 'PUT',
                    body: file
                });
                
                if (!s3Response.ok) {
                    const errorText = await s3Response.text();
                    throw new Error(`S3 upload failed: ${s3Response.status} - ${errorText}`);
                }
                
                log('‚úÖ File uploaded to S3 successfully!', 'success');
                
                // Step 3: Confirm upload
                log('üîÑ Confirming upload...', 'info');
                const confirmResponse = await fetch(`${API_BASE_URL}/file-upload`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        action: 'confirm',
                        file_id: uploadData.file_id,
                        file_size: file.size
                    })
                });
                
                if (!confirmResponse.ok) {
                    const errorText = await confirmResponse.text();
                    throw new Error(`Upload confirmation failed: ${confirmResponse.status} - ${errorText}`);
                }
                
                log('üéâ Upload completed successfully!', 'success');
                document.getElementById('downloadFileId').value = uploadData.file_id;
                
                // Auto-refresh file list
                setTimeout(listFiles, 1000);
                
            } catch (error) {
                log(`‚ùå Upload failed: ${error.message}`, 'error');
            } finally {
                document.getElementById('uploadProgress').style.display = 'none';
                document.getElementById('uploadProgressBar').style.width = '0%';
            }
        }
        
        async function listFiles() {
            if (!API_BASE_URL || !AUTH_TOKEN) {
                log('Please configure API URL and Auth Token first', 'error');
                return;
            }
            
            try {
                log('üîÑ Loading file list...', 'info');
                
                const response = await fetch(`${API_BASE_URL}/file-upload`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        action: 'list'
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`List files failed: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                const files = data.files || [];
                
                log(`‚úÖ Found ${files.length} files`, 'success');
                
                const fileListElement = document.getElementById('fileList');
                if (files.length === 0) {
                    fileListElement.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No files found</p>';
                    return;
                }
                
                fileListElement.innerHTML = files.map(file => `
                    <div class="file-item">
                        <div class="file-info">
                            <div class="file-name">${file.original_filename}</div>
                            <div class="file-meta">
                                Size: ${formatFileSize(file.file_size)} | 
                                Status: ${file.upload_status} | 
                                Uploaded: ${new Date(file.created_at).toLocaleString()}
                            </div>
                        </div>
                        <div class="file-actions">
                            <button class="btn btn-small btn-secondary" onclick="downloadFile('${file.file_id}', '${file.original_filename}')">üì• Download</button>
                            <button class="btn btn-small" onclick="copyFileId('${file.file_id}')">üìã Copy ID</button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                log(`‚ùå Failed to load file list: ${error.message}`, 'error');
            }
        }
        
        async function testDownloadUrl() {
            const fileId = document.getElementById('downloadFileId').value;
            
            if (!fileId) {
                log('Please enter a file ID', 'error');
                return;
            }
            
            if (!API_BASE_URL || !AUTH_TOKEN) {
                log('Please configure API URL and Auth Token first', 'error');
                return;
            }
            
            try {
                log(`üîÑ Generating download URL for file: ${fileId}`, 'info');
                
                const response = await fetch(`${API_BASE_URL}/file-upload`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        action: 'download',
                        file_id: fileId
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Download URL generation failed: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                log(`‚úÖ Download URL generated successfully!`, 'success');
                log(`üìé URL: ${data.download_url.substring(0, 100)}...`, 'info');
                log(`‚è∞ Expires in: ${data.expires_in} seconds`, 'info');
                
                if (data.cors_note) {
                    log(`üí° CORS Note: ${data.cors_note}`, 'info');
                }
                
            } catch (error) {
                log(`‚ùå Failed to generate download URL: ${error.message}`, 'error');
            }
        }
        
        async function testFetchDownload() {
            const fileId = document.getElementById('downloadFileId').value;
            
            if (!fileId) {
                log('Please enter a file ID', 'error');
                return;
            }
            
            try {
                log(`üîÑ Testing fetch download for file: ${fileId}`, 'info');
                
                // First get download URL
                const urlResponse = await fetch(`${API_BASE_URL}/file-upload`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        action: 'download',
                        file_id: fileId
                    })
                });
                
                if (!urlResponse.ok) {
                    throw new Error(`Download URL generation failed: ${urlResponse.status}`);
                }
                
                const urlData = await urlResponse.json();
                log(`‚úÖ Download URL obtained`, 'success');
                
                // Now try to fetch the file
                log(`üîÑ Attempting fetch download...`, 'info');
                const fileResponse = await fetch(urlData.download_url);
                
                if (!fileResponse.ok) {
                    throw new Error(`Fetch download failed: ${fileResponse.status}`);
                }
                
                const blob = await fileResponse.blob();
                log(`‚úÖ Fetch download successful! Downloaded ${blob.size} bytes`, 'success');
                
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = urlData.filename || 'downloaded_file';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                log(`üì• File download initiated: ${urlData.filename}`, 'success');
                
            } catch (error) {
                log(`‚ùå Fetch download failed: ${error.message}`, 'error');
                log(`üí° This might be a CORS issue. Try Direct Download instead.`, 'info');
            }
        }
        
        async function testDirectDownload() {
            const fileId = document.getElementById('downloadFileId').value;
            
            if (!fileId) {
                log('Please enter a file ID', 'error');
                return;
            }
            
            try {
                log(`üîÑ Testing direct download for file: ${fileId}`, 'info');
                
                const response = await fetch(`${API_BASE_URL}/file-upload`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        action: 'download',
                        file_id: fileId
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Download URL generation failed: ${response.status}`);
                }
                
                const data = await response.json();
                log(`‚úÖ Opening direct download...`, 'success');
                
                // Open in new tab - this bypasses CORS
                window.open(data.download_url, '_blank');
                
                log(`üì• Direct download opened in new tab`, 'success');
                
            } catch (error) {
                log(`‚ùå Direct download failed: ${error.message}`, 'error');
            }
        }
        
        async function downloadFile(fileId, filename) {
            try {
                log(`üîÑ Downloading: ${filename}`, 'info');
                
                const response = await fetch(`${API_BASE_URL}/file-upload`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        action: 'download',
                        file_id: fileId
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Download failed: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Try fetch first, fallback to direct download
                try {
                    const fileResponse = await fetch(data.download_url);
                    if (fileResponse.ok) {
                        const blob = await fileResponse.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        log(`‚úÖ Downloaded: ${filename}`, 'success');
                    } else {
                        throw new Error('Fetch failed');
                    }
                } catch (fetchError) {
                    // Fallback to direct download
                    window.open(data.download_url, '_blank');
                    log(`üì• Direct download opened: ${filename}`, 'success');
                }
                
            } catch (error) {
                log(`‚ùå Download failed: ${error.message}`, 'error');
            }
        }
        
        function copyFileId(fileId) {
            navigator.clipboard.writeText(fileId).then(() => {
                log(`üìã File ID copied: ${fileId}`, 'success');
                document.getElementById('downloadFileId').value = fileId;
            });
        }
        
        function clearFileList() {
            document.getElementById('fileList').innerHTML = '';
            log('üóëÔ∏è File list cleared', 'info');
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html> 